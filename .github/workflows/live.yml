name: Live Relay M3U8 + Audio YouTube Custom

on:
  workflow_dispatch:
    inputs:
      m3u8_url:
        description: '1. Link .m3u8 (Video)'
        required: true
      audio_url:
        description: '2. Link YouTube (Audio)'
        required: true
      kunci_rtmp:
        description: '3. Stream Key YouTube'
        required: true

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Install Tools (FFmpeg & yt-dlp Nightly)
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg jq curl
          # Menggunakan versi nightly agar lebih kuat tembus proteksi YT
          sudo curl -L https://github.com/yt-dlp/yt-dlp-nightly-builds/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp -U

      - name: 4. Jalankan Relay Streaming
        env:
          YT_COOKIES: ${{ secrets.YT_COOKIES }}
        run: |
          set +e
          echo "$YT_COOKIES" > cookies.txt
          
          while true; do
            echo "--- [$(date)] Mengambil Direct Link Audio YouTube ---"
            
            # Menggunakan settingan extractor yang sama dengan script relay pro
            AUDIO_STREAM=$(yt-dlp --cookies cookies.txt \
                               --js-runtime node \
                               --force-ipv4 \
                               --no-playlist \
                               --extractor-args "youtube:player_client=mweb,web" \
                               -f "bestaudio/best" \
                               -g "${{ github.event.inputs.audio_url }}" 2>/dev/null)

            if [ -z "$AUDIO_STREAM" ]; then
              echo "Gagal ambil URL Audio. Mencoba tanpa extractor-args..."
              AUDIO_STREAM=$(yt-dlp --cookies cookies.txt --js-runtime node -f "bestaudio" -g "${{ github.event.inputs.audio_url }}" 2>/dev/null)
            fi

            if [ -z "$AUDIO_STREAM" ]; then
              echo "CRITICAL ERROR: Gagal ambil audio. Cek Cookies!"
              sleep 10
              continue
            fi

            echo "SUMBER DITEMUKAN! Memulai Relay..."
            echo "Video: ${{ github.event.inputs.m3u8_url }}"
            echo "Audio: YouTube Stream"

            # Proses Penggabungan:
            # -re pada input agar streaming realtime
            # -map 0:v:0 mengambil video dari m3u8
            # -map 1:a:0 mengambil audio dari youtube
            ffmpeg -re -i "${{ github.event.inputs.m3u8_url }}" \
              -re -i "$AUDIO_STREAM" \
              -c:v libx264 -preset veryfast -b:v 3000k -maxrate 3000k -bufsize 6000k \
              -g 60 -keyint_min 60 -sc_threshold 0 \
              -c:a aac -ar 44100 -b:a 128k \
              -map 0:v:0 -map 1:a:0 -shortest \
              -f flv "rtmp://a.rtmp.youtube.com/live2/${{ github.event.inputs.kunci_rtmp }}"

            echo "Stream terputus atau selesai. Mengulang dalam 5 detik..."
            sleep 5
          done
          
